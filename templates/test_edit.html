{% extends "base.html" %}

{% block title %}Test Edit - Instagram Editor{% endblock %}

{% block extra_css %}
<style>
    .back-link {
        color: #0095f6;
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 20px;
        display: inline-block;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .edit-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .image-preview {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #dbdbdb;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
    }

    .form-input:focus {
        outline: none;
        border-color: #0095f6;
    }

    textarea.form-input {
        min-height: 120px;
        resize: vertical;
    }

    .help-text {
        font-size: 12px;
        color: #8e8e8e;
        margin-top: 5px;
    }

    .submit-btn {
        width: 100%;
        padding: 15px;
        font-size: 16px;
    }

    #loadingState {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0095f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<a href="/carousel/{{ carousel.id }}" class="back-link">‚Üê Back to carousel</a>

<div class="edit-container">
    <div class="card">
        <img src="{{ image.local_path or image.image_url }}" alt="Selected image" class="image-preview">

        <div class="card-body">
            <h3 style="margin-bottom: 20px;">Test Edit with NanaBanana</h3>

            <div id="editForm">
                <div class="form-group">
                    <label class="form-label">Edit Prompt</label>
                    <textarea id="editPrompt" class="form-input" placeholder="Example: A woman wearing a red sundress, standing on a tropical beach with palm trees, golden hour lighting"></textarea>
                    <div class="help-text">
                        Describe the outfit and background changes you want. Keep pose and person the same.
                    </div>
                </div>

                <button class="btn btn-primary submit-btn" onclick="submitEdit()">
                    Generate Edit with NanaBanana
                </button>
            </div>

            <div id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p>Generating edit with NanaBanana...</p>
                <p style="font-size: 12px; color: #8e8e8e; margin-top: 10px;">This may take 10-30 seconds</p>
            </div>
        </div>
    </div>
</div>

<script>
function submitEdit() {
    const prompt = document.getElementById('editPrompt').value.trim();

    if (!prompt) {
        alert('Please enter an edit prompt');
        return;
    }

    // Show loading state
    document.getElementById('editForm').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';

    // Submit to API
    fetch('/api/submit_edit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_id: '{{ image.id }}',
            carousel_id: '{{ carousel.id }}',
            edit_prompt: prompt
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to review page
            window.location.href = '/review/' + data.test_id;
        } else {
            alert('Error: ' + data.error);
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        document.getElementById('editForm').style.display = 'block';
        document.getElementById('loadingState').style.display = 'none';
    });
}
</script>
{% endblock %}
